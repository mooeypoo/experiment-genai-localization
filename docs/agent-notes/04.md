# Step 04 — Create User Form Enhancement

## 1) Summary

This step reworks the "Add a user" form to match the prompt's specified fields: **display name** (required) and **bio** (optional). The previous "Username" field was removed from the form; usernames are now auto-generated from the display name by the data layer. The `createUser` store function was updated to validate input and return a `{ user, errors }` result object, harmonizing it with the `createComment` pattern introduced in step 03. New users appear immediately in both the user grid and the "Viewing as" header dropdown.

## 2) Decisions & Rationale

### Removed the username form field; auto-generate from display name
The prompt specifies exactly two fields: display name and bio. The previous form had "Name" and "Username." Since the data model still requires a `username` (used for `@handles` and avatar URLs), the store now derives it automatically by slugifying the display name (lowercase, non-alphanumeric characters replaced with hyphens). This eliminates a field the user doesn't need to think about while preserving the data model's integrity.

### Username collision handling
The slugify function could produce duplicate usernames (e.g., two "Alice Martin" users would both slug to `alice-martin`). A `while` loop appends an incrementing suffix (`-2`, `-3`, ...) until the username is unique within the current state. This is simple, deterministic, and sufficient for an in-memory store.

### `createUser` now returns `{ user, errors }` 
In step 03, `createComment` was refactored to return a result object with validation errors. `createUser` still returned a bare object and relied on the component for validation. This step aligns the two mutation APIs so both follow the same pattern. The component is now a thin caller that delegates all validation to the store and displays whatever errors come back.

### Display name is the only required field
The prompt says "display name is required" and "bio optional." The validation in `createUser` only checks for a non-empty (after trim) name. Bio defaults to an empty string and is trimmed before storage. No other constraints (length, character set) are enforced because none were requested.

### Bio uses a `<textarea>` instead of `<input>`
Bios can be multi-sentence, so a textarea with `rows="2"` gives the user more room than a single-line input. It also visually distinguishes the optional freetext field from the required name field.

## 3) Ambiguities Encountered

### What happens to the username field?
**Options considered:**
1. Keep the username field in the form alongside the new bio field (three fields total).
2. Remove the username field and require the store to auto-generate it.
3. Remove the username field and drop the username concept entirely.

**Resolution:** Option 2. The prompt explicitly lists two fields. Dropping the username from the data model (option 3) would break `UserCard`, `UserProfileView`, and avatar generation. Auto-generating it from the display name preserves all downstream consumers without requiring a form field.

### How to generate the username slug?
**Options considered:**
1. Take the first name only (e.g., "Alice Martin" → "alice").
2. Slugify the full name (e.g., "Alice Martin" → "alice-martin").
3. Use a random string or the user's ID.

**Resolution:** Option 2. It produces readable, recognizable handles. Option 1 would collide frequently with common first names. Option 3 would produce ugly, meaningless handles.

### Should the form clear on successful submission?
**Options considered:**
1. Clear both fields on success.
2. Leave fields populated so the user can create a similar user quickly.

**Resolution:** Option 1. Clearing signals that the action succeeded and prevents accidental re-submission. This matches the comment form's behavior.

### Should the newly created user be auto-selected in "Viewing as"?
**Options considered:**
1. Automatically switch the current user to the newly created one.
2. Leave the current user unchanged.

**Resolution:** Option 2. Automatically switching identities would be surprising. The user can manually switch via the header dropdown if they want to "be" the new user.

## 4) Tradeoffs

| Decision | Upside | Downside |
|---|---|---|
| Auto-generated username | One fewer form field; simpler UX | User can't choose their handle; may get an ugly slug from unusual names |
| Collision-avoidance suffix | Guarantees uniqueness | Produces handles like `alice-martin-2` which look slightly odd |
| `{ user, errors }` return pattern | Consistent API across all mutations | Callers must destructure the result; slightly more verbose than returning the user directly |
| Bio as optional textarea | Matches the prompt; room for longer text | Form is taller; the optional field might confuse users who think it's required |

## 5) Non-Goals

- **Username customization.** Users cannot pick their own handle. If this becomes important, a future step could add an "advanced" toggle or an editable slug field.
- **Profile editing.** The form creates users; there is no way to edit name or bio after creation.
- **Avatar upload.** Avatars remain auto-generated via DiceBear from the username.
- **Input length limits.** No minimum/maximum is enforced on name or bio.

## 6) Files Changed

| File | Change | Purpose |
|---|---|---|
| `src/data/store.js` | **Modified** | Added `slugify` helper; `createUser` now auto-generates `username`, validates name, and returns `{ user, errors }` |
| `src/components/CreateUserForm.vue` | **Modified** | Replaced "Username" input with "Bio" textarea; renamed "Name" to "Display name"; added error display; uses `{ user, errors }` result from store |
| `docs/agent-notes/04.md` | **New** | This file |

## 7) Manual Verification Checklist

- [ ] `npm run build` succeeds.
- [ ] The "Add a user" form on the Users page shows "Display name" and "Bio" fields.
- [ ] Submitting with an empty display name shows "Display name is required." error.
- [ ] Submitting with only a display name (no bio) creates a user successfully.
- [ ] The new user appears immediately in the user grid.
- [ ] The new user appears in the "Viewing as" header dropdown.
- [ ] The auto-generated username is a lowercase slug of the display name (e.g., "Eve Nakamura" → `@eve-nakamura`).
- [ ] Creating two users with the same display name produces distinct usernames (e.g., `@eve-nakamura` and `@eve-nakamura-2`).
- [ ] Clicking the new user's card navigates to their profile page.
- [ ] The profile page shows the bio (or "No bio yet." if bio was left empty).
- [ ] Both form fields clear after successful submission.
- [ ] The error list clears after successful submission.

## 8) Known Issues / Follow-ups

- **No way to edit a user after creation.** The profile page is read-only; adding an edit form is a natural follow-up.
- **Username slugification is naive.** Non-Latin characters (e.g., Chinese, Arabic) are stripped entirely, which could produce empty or very short slugs. A transliteration library or fallback to the user ID would be more robust.
- **No feedback toast or animation.** After creating a user, the only confirmation is the card appearing in the grid. A brief success message or highlight animation would improve perceived responsiveness.
- **The "Viewing as" dropdown does not auto-select the new user.** This was a deliberate choice (see Ambiguities), but some users might expect to be switched automatically.
