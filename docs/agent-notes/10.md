# Step 10 — Locale-Aware User Sorting

## Summary

Prior to this step, `getUsers()` returned users in insertion order — whatever order they appear in `state.users`. The Users page rendered them as-is with no sorting applied, meaning the seeded four users appeared in seed-file order and newly created users always appended to the end of the list.

This step adds locale-aware alphabetical sorting so users appear in a meaningful, predictable order that respects the linguistic collation rules of the currently selected language.

## Decisions & Rationale

### Where to sort: view, not store

The first decision was where to introduce the sort.

**Option A — Sort inside `getUsers()` in the store.**
This would require importing `locale` from `src/i18n/index.js` inside `src/data/store.js`. That introduces a dependency from the data layer into the i18n layer, coupling two modules that should be independent. The store's responsibility is managing data; what order to display that data in is a UI concern. Additionally, `getUsers()` currently returns the reactive `state.users` array directly, so callers can watch it for new additions. Sorting inside the store would mean either mutating the stored order (a side-effect) or wrapping the return in a computed (leaking reactivity contracts), both of which complicate the data layer unnecessarily.

**Option B — Sort in `UsersView.vue` using a `computed`.**
The view already imports `locale` (indirectly, as it imports `t` from `src/i18n/index.js`). Adding a `sortedUsers` computed here keeps the store language-agnostic, the i18n module data-agnostic, and the sort logic exactly where it is consumed. This is the chosen approach.

### How to sort: `Intl.Collator`, not `String.prototype.localeCompare`

Two mechanisms can perform locale-aware string comparison:

1. `a.localeCompare(b, locale)` — convenient but creates a new implicit collator on every comparison. In an array of N users the comparator is called O(N log N) times, and some environments do not reliably forward the locale argument.
2. `new Intl.Collator(locale, options)` — creates one collator instance up front; the `.compare` method is reused for every pair. This is the specification-recommended approach for repeated comparisons and produces consistent behaviour across engines.

`Intl.Collator` is used with `sensitivity: 'base'`, meaning differences in accents and case do not affect the primary sort order. "Alice" and "alice" are equivalent for position, as are "Étienne" and "Etienne" — only the base letter matters for ordering. This is the most natural collation for a name list.

### Sort key: `user.name`

The sort is applied on `user.name` (the display name stored in the data model) rather than `getDisplayName(user.id)` (which resolves `preferredName || name`). The rationale:

- The `UserCard` component prominently displays `user.name` and `user.username`; the preferred name is a conversational nickname used in the "Posting as" context, not in the list card.
- Sorting by the field that is visually displayed is the principle of least surprise — the card you see is the card you'd expect to find when scanning alphabetically.
- If the sort key were `preferredName`, users without a preferred name would sort by `name`, but users with one would sort by a different value than the one shown in the card, creating an inconsistency.

### The computed is a fresh sorted copy

```js
const sortedUsers = computed(() => {
  const collator = new Intl.Collator(locale.value, { sensitivity: 'base' })
  return [...users].sort((a, b) => collator.compare(a.name, b.name))
})
```

`[...users]` creates a shallow copy before sorting. This is essential: `Array.prototype.sort` mutates in place, and `users` is a reference to the reactive `state.users` array. Mutating it directly would reorder the underlying store array, changing insertion order for operations that depend on it (e.g., `currentUser` initialising from `state.users[0]`). The spread creates a new array that Vue's reactivity system treats as a derived value, not a mutation.

Because `locale` and `users` are both reactive, the computed re-evaluates whenever either changes — a new user is created, or the language is switched.

## Ambiguities Encountered

### Should newly created users sort by their preferred name?

The `preferredName` field exists on users (added in Step 05) and may differ from `user.name`. Sorting by the displayed card label (`user.name`) was chosen, but an argument exists for sorting by `getDisplayName` if the intent is "sort by how we refer to this person".

**Resolution:** Sort by `user.name` for the reason stated above (it matches what the card shows). If future design changes make the card display `preferredName` prominently, the sort key should be revisited.

### Should there be a user-facing sort control?

The prompt asks to "improve user sorting behaviour" and "respect the currently selected language", which was interpreted as: always sort alphabetically using the active locale's collation rules. No sort control (e.g., "Sort by name / Sort by newest") was added.

**Resolution:** No control was added. The implicit alphabetical order is the most natural default and has no ambiguity in intent. A sort control is a future enhancement if needed.

### Should the `Viewing as` dropdown in the header also be sorted?

The `AppHeader.vue` "Viewing as" dropdown iterates `getUsers()` directly and currently renders in insertion order.

**Resolution:** Not sorted in this step. The `Viewing as` selector is a functional control, not a browseable list — users typically know who they want to select. Keeping it in insertion order (seeded users first, then newly created) avoids the dropdown reordering unexpectedly mid-session. If the user list grows large, sorting there too would be reasonable, but it is out of scope for this step.

## Tradeoffs

| Aspect | Decision | Alternative | Reason |
|---|---|---|---|
| Sort location | `UsersView.vue` computed | `getUsers()` in store | Keeps store language-agnostic |
| Comparison method | `Intl.Collator` | `localeCompare` | Collator instance reuse; explicit locale forwarding |
| Sort key | `user.name` | `getDisplayName(user.id)` | Matches the value shown in the card |
| Sort mutability | Sorted copy (`[...users].sort`) | In-place sort on `state.users` | Avoids mutating store order |
| Sort direction | Ascending (A→Z) | User-controlled / descending | Most natural default for a names list |

## Non-Goals

- **Sorting comments.** Comments are displayed chronologically and were not changed.
- **Sorting the `Viewing as` dropdown.** Left in insertion order for the reasons above.
- **Persisting sort preference.** No sort-control UI was added; order is always ascending by `user.name` for the active locale.
- **Multi-level sorting** (e.g., last name as primary key, first name as secondary). `user.name` is a single string; no name-parsing was attempted.

## Files Changed

| File | Change |
|---|---|
| `src/views/UsersView.vue` | Added `computed` import and `locale` import from `src/i18n/index.js`; introduced `sortedUsers` computed using `Intl.Collator`; changed `v-for` source from `users` to `sortedUsers` |

No changes to the store, router, or any other component were required.

## Manual Verification Checklist

- [x] With English locale, seeded users appear as: Alice Martin, Bob Chen, Carol Diaz, Dan Okafor (A → B → C → D).
- [x] Creating "Aaron Smith" immediately inserts him before Alice Martin (confirms sort is live, not one-time).
- [x] With French locale, creating "Étienne Blanc" places him after Dan Okafor and before any user whose name starts with F — confirming that É sorts with E, not after Z as a raw Unicode sort would produce.
- [x] Switching locale re-sorts the grid reactively without a page reload.
- [x] Switching locale back to English preserves correct alphabetical order.
- [x] Page refresh (which resets state to seed data) restores the original sorted order.

## Known Issues / Follow-ups

- **`Viewing as` dropdown is unsorted.** If the user list grows, it may become harder to use. A future step could apply the same `Intl.Collator` logic there.
- **Username generated from name loses accents** (`slugify` strips non-ASCII characters, so "Étienne Blanc" becomes `@tienne-blanc`). This is a pre-existing limitation in the slug generation, not introduced here.
- **Sort key is `user.name`, not `preferredName`.** If preferred names become the primary card label in a future design iteration, the sort key should be updated to match.
